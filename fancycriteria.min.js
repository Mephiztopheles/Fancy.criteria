!function(){function forEach(arr,fn){for(var i in arr)if(arr.hasOwnProperty(i)){var result=fn.call(arr[i],i);if(void 0!==result)return result}return null}function getObject(obj,key){return key?Fancy.getKey(obj,key):obj}function condition(it){var field=getObject(it,this.key),cond=FancyCriteria.conditions[this.type];return cond&&"function"==typeof cond?cond(field,this.value):!1}function FancyCriteria(array){function sort(arr){return arr.sort(function(a,b){var propertyA=Fancy.getKey(a,SELF.q.sort.split(",")[0]),propertyB=Fancy.getKey(b,SELF.q.sort.split(",")[0]),direction=SELF.q.sort.split(",")[1];return"desc"===direction?propertyB>propertyA:propertyA>propertyB})}function resetQuery(){query="",SELF.q={and:[],or:[],max:null,offset:null,sort:null}}function setQuery(){function getValue(value){if(value.indexOf("and")>0){var list=[];return value.split(" and ").forEach(function(it){list.push(JSON.parse(it))}),list}return JSON.parse(value)}var q=query;resetQuery();for(var i in FancyCriteria)if(FancyCriteria.hasOwnProperty(i)&&i.toUpperCase()===i){var regexOr=new RegExp("OR \\S* "+FancyCriteria[i]+" ((?!"+operators+").)*","g"),regexAnd=new RegExp("AND \\S* "+FancyCriteria[i]+" ((?!"+operators+").)*","g"),matchOr=q.match(regexOr),matchAnd=q.match(regexAnd);matchOr&&matchOr.forEach(function(it){var key=it.match(/OR (\S*) /),value=it.trim().match(new RegExp(FancyCriteria[i]+" (.*)$"));if(key&&value)if(key=key[1],value=getValue(value[1]),"array"===Fancy.getType(value)){var args=[FancyCriteria[i],key];value.forEach(function(arg){args.push(arg)}),SELF.or.apply(SELF,args)}else SELF.or(FancyCriteria[i],key,value)}),matchAnd&&matchAnd.forEach(function(it){var key=it.match(/AND (\S*) /),value=it.trim().match(new RegExp(FancyCriteria[i]+" (.*)$"));if(key&&value)if(key=key[1],value=getValue(value[1]),"array"===Fancy.getType(value)){var args=[FancyCriteria[i],key];value.forEach(function(arg){args.push(arg)}),SELF.and.apply(SELF,args)}else SELF.and(FancyCriteria[i],key,value)})}var regexMax=new RegExp("MAX (null|\\d*)(?=(?!"+operators+").)*"),regexOffset=new RegExp("OFFSET (null|\\d*)(?=(?!"+operators+").)*"),regexSort=new RegExp("SORT (null|\\S*)(?=(?!"+operators+").)*"),matchMax=q.match(regexMax),matchOffset=q.match(regexOffset),matchSort=q.match(regexSort);matchMax&&matchMax.forEach(function(it){var value=it.trim().match(/MAX (.*)/);value&&(value=JSON.parse(value[1]),SELF.max(value))}),matchOffset&&matchOffset.forEach(function(it){var value=it.trim().match(/OFFSET (.*)/);value&&(value=JSON.parse(value[1]),SELF.offset(value))}),matchSort&&matchSort.forEach(function(it){var value=it.trim().match(/SORT (.*)/);if(value){var property=value[1].split(",")[0],direction=value[1].split(",")[1];SELF.sort(property,direction)}})}function addQuery(operator,key,type,value){query&&(query+=" ");var args=[operator,key];type&&args.push(type),void 0!==value&&("array"===Fancy.getType(value)?value.forEach(function(it,i){i&&args.push("and"),args.push(JSON.stringify(it))}):args.push(JSON.stringify(value))),query+=args.join(" ")}if("array"!==Fancy.getType(array))throw"Error: It doesn't make sense to search in "+Fancy.getType(array)+"s";if(this===Fancy)return new FancyCriteria(array);logged||(logged=!0,Fancy.version(this));var query,SELF=this;return Object.defineProperty(this,"query",{get:function(){return query},set:function(value){query=value,setQuery()}}),resetQuery(),this.or=function(type,key,value){if(arguments.length>3){value=[value];for(var i in arguments)arguments.hasOwnProperty(i)&&parseInt(i)>2&&value.push(arguments[i])}return addQuery("OR",key,type,value),this.q.or.push({type:type,key:key,value:value}),this},this.and=function(type,key,value){if(arguments.length>3){value=[value];for(var i in arguments)arguments.hasOwnProperty(i)&&parseInt(i)>2&&value.push(arguments[i])}return addQuery("AND",key,type,value),this.q.and.push({type:type,key:key,value:value}),this},this.offset=function(value){return this.q.offset=value,addQuery("OFFSET",value),this},this.max=function(value){return this.q.max=value,addQuery("MAX",value),this},this.sort=function(property,direction){return this.q.sort=property+","+direction,addQuery("SORT",this.q.sort),this},this.list=function(index){var list=[],sortedArray=array;if(SELF.q.sort&&(sortedArray=sort(array)),sortedArray.forEach(function(it,i){var AND=!0,OR=0==SELF.q.or.length;forEach(SELF.q.and,function(){var bool=condition.call(this,it);return bool?void 0:(AND=!1,!1)}),forEach(SELF.q.or,function(){var bool=condition.call(this,it);return bool?(OR=!0,!1):void 0}),OR&&AND&&(index?list[i]=it:list.push(it))}),SELF.q.offset)for(var i=0;i<SELF.q.offset;)list.shift(),i++;return SELF.q.max&&list.splice(SELF.q.max),list},this.get=function(index){var sortedArray=array;return SELF.q.sort&&(sortedArray=sort(array)),forEach(sortedArray,function(i){if(!(SELF.q.offset&&SELF.q.offset>i)){var it=this,AND=!0,OR=0==SELF.q.or.length;return forEach(SELF.q.and,function(){var bool=condition.call(this,it);return bool?void 0:(AND=!1,!1)}),forEach(SELF.q.or,function(){var bool=condition.call(this,it);return bool?(OR=!0,!1):void 0}),OR&&AND?index?{index:i.match(/^\d*$/)?parseInt(i):i,result:it}:it:void 0}})},this.copy=function(){var criteria=new FancyCriteria(array);return criteria.query=query,criteria},this}var NAME="FancyCriteria",VERSION="0.0.5",logged=!1,operators="OR|MAX|OFFSET|AND|SORT";FancyCriteria.api=FancyCriteria.prototype={},FancyCriteria.api.version=VERSION,FancyCriteria.api.name=NAME,FancyCriteria.LIKE="like",FancyCriteria.EQUALS="eq",FancyCriteria.LOWER_THAN="lt",FancyCriteria.LOWER_THAN_EQUALS="lte",FancyCriteria.GREATER_THAN="gt",FancyCriteria.GREATER_THAN_EQUALS="gte",FancyCriteria.BETWEEN="bt",FancyCriteria.NOT="not",FancyCriteria.NOTNULL="notnull",FancyCriteria.conditions={},FancyCriteria.conditions[FancyCriteria.LIKE]=function(objectValue,conditionValue){return null!==objectValue&&"undefined"!=typeof objectValue?objectValue.toString().indexOf(conditionValue)>=0:!1},FancyCriteria.conditions[FancyCriteria.EQUALS]=function(objectValue,conditionValue){return objectValue===conditionValue},FancyCriteria.conditions[FancyCriteria.LOWER_THAN]=function(objectValue,conditionValue){return conditionValue>objectValue},FancyCriteria.conditions[FancyCriteria.LOWER_THAN_EQUALS]=function(objectValue,conditionValue){return conditionValue>=objectValue},FancyCriteria.conditions[FancyCriteria.GREATER_THAN]=function(objectValue,conditionValue){return objectValue>conditionValue},FancyCriteria.conditions[FancyCriteria.GREATER_THAN_EQUALS]=function(objectValue,conditionValue){return objectValue>=conditionValue},FancyCriteria.conditions[FancyCriteria.BETWEEN]=function(objectValue,conditionValue){return objectValue>conditionValue[0]&&objectValue<conditionValue[1]},FancyCriteria.conditions[FancyCriteria.NOT]=function(objectValue,conditionValue){return objectValue!==conditionValue},FancyCriteria.conditions[FancyCriteria.NOTNULL]=function(objectValue){return"undefined"!=typeof objectValue&&null!==objectValue},Fancy.criteria=FancyCriteria}();
//# sourceMappingURL=fancycriteria.min.js.map